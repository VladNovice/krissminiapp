<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KRISS — Noir Edition 2026</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg: #000;
            --glass: rgba(255,255,255,0.04);
            --glass-strong: rgba(255,255,255,0.07);
            --glass-border: rgba(255,255,255,0.08);
            --accent: #fff;
            --muted: rgba(255,255,255,0.55);
            --success: #4BB543;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%}
        body{
            background:var(--bg);
            color:var(--accent);
            font-family:'Inter',-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            overflow-x:hidden;
        }
        canvas{position:fixed;inset:0;width:100%;height:100%;z-index:0;pointer-events:none;opacity:0.3}
        .app{position:relative;z-index:1;padding:calc(env(safe-area-inset-top) + 14px) 16px 160px}

        header{display:flex;align-items:center;gap:12px;padding-bottom:18px}
        .logo{font-weight:700;font-size:20px;letter-spacing:-1px}

        .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
        .card{background:var(--glass);border-radius:18px;overflow:hidden;border:0.5px solid var(--glass-border);transition:transform .22s ease,box-shadow .22s ease}
        .card:active{transform:scale(.985)}
        .img-wrap{width:100%;aspect-ratio:0.8;overflow:hidden}
        .card img{width:100%;height:100%;object-fit:cover;display:block}
        .card-body{padding:12px}
        .card-name{font-size:13px;font-weight:500;opacity:0.95}
        .card-price{font-size:14px;font-weight:700;margin-top:6px}

        /* ---------- MODAL IMPROVED ---------- */
        .modal{position:fixed;inset:0;display:none;z-index:2000;align-items:flex-end;}
        .modal-backdrop{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.55),rgba(0,0,0,0.6));backdrop-filter:blur(8px);}
        .modal-sheet{
            width:100%;max-width:980px;margin:0 auto;border-radius:20px 20px 0 0;background:linear-gradient(180deg,#070707, #000);
            box-shadow:0 -30px 60px rgba(0,0,0,0.6);transform:translateY(100%);transition:transform .42s cubic-bezier(.22,.9,.2,1);overflow:hidden;display:flex;flex-direction:column;max-height:95vh
        }
        .modal.show .modal-sheet{transform:translateY(0)}

        .modal-header{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;padding:calc(env(safe-area-inset-top) + 12px) 18px;background:linear-gradient(180deg,rgba(0,0,0,.35),transparent);z-index:10}
        .modal-title{font-size:16px;font-weight:700;opacity:0.95}
        .modal-actions{display:flex;gap:10px;align-items:center}
        .icon-btn{width:36px;height:36px;border-radius:10px;background:var(--glass-strong);display:inline-flex;align-items:center;justify-content:center;border:0.5px solid var(--glass-border)}

        .modal-content{overflow:auto;padding-bottom:150px}

        /* Gallery */
        .gallery{position:relative;width:100%;aspect-ratio:0.85;background:linear-gradient(180deg,#080808,#0c0c0c)}
        .gallery-scroll{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;scroll-behavior:smooth;height:100%}
        .gallery-scroll::-webkit-scrollbar{display:none}
        .gallery-item{min-width:100%;scroll-snap-align:start;display:flex;align-items:center;justify-content:center}
        .gallery-item img{width:100%;height:100%;object-fit:cover}

        .gallery-controls{position:absolute;inset:auto 12px 12px 12px;display:flex;justify-content:space-between;align-items:center}
        .arrow{width:38px;height:38px;border-radius:10px;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.06)}

        .gallery-dots{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;display:flex;gap:8px;padding:6px 8px;background:rgba(0,0,0,0.35);border-radius:14px}
        .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,0.2);transition:all .25s}
        .dot.active{width:22px;border-radius:10px;background:#fff}

        /* Details */
        .details{padding:22px}
        .product-top{display:flex;justify-content:space-between;align-items:flex-start;gap:18px}
        .product-info{flex:1}
        .product-title{font-size:26px;font-weight:700;margin-bottom:6px}
        .product-price{font-size:20px;font-weight:800;margin-top:4px}
        .product-desc{color:var(--muted);font-weight:300;line-height:1.5;margin-top:10px}

        .meta-row{display:flex;gap:12px;margin-top:18px}
        .size-selector{display:flex;gap:12px}
        .size-chip{padding:10px 14px;border-radius:14px;background:var(--glass);border:0.5px solid var(--glass-border);min-width:44px;text-align:center;font-weight:600;cursor:pointer;transition:transform .15s ease}
        .size-chip.active{background:#fff;color:#000;transform:scale(1.03)}

        .qty{display:flex;align-items:center;gap:8px;background:var(--glass);padding:6px;border-radius:12px;border:0.5px solid var(--glass-border)}
        .qty button{background:transparent;border:0;color:var(--accent);font-size:18px;padding:6px;cursor:pointer}
        .qty span{min-width:28px;text-align:center;font-weight:700}

        .cta-row{position:sticky;bottom:0;display:flex;gap:12px;padding:16px;background:linear-gradient(180deg,transparent,#000);z-index:20}
        .add-btn{flex:1;padding:16px;border-radius:14px;background:#fff;color:#000;border:0;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px}
        .buy-btn{width:68px;padding:12px;border-radius:12px;background:transparent;border:1px solid var(--glass-border);display:flex;align-items:center;justify-content:center}

        /* sheet checkout (kept) */
        .sheet{position:fixed;bottom:0;left:0;width:100%;height:auto;background:#1c1c1e;border-radius:24px 24px 0 0;z-index:3000;padding:20px 20px calc(env(safe-area-inset-bottom) + 26px);transform:translateY(110%);transition:transform .4s}
        .sheet.active{transform:translateY(0)}

        /* pay overlay */
        .pay-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:5000;display:none;align-items:center;justify-content:center;flex-direction:column}

        @media(min-width:900px){
            .modal-sheet{border-radius:14px;max-width:700px}
            .product-top{align-items:center}
        }

    </style>
</head>
<body>

<canvas id="sakura"></canvas>

<div class="app">
    <header>
        <div class="logo">KRISS</div>
    </header>

    <div class="grid" id="catalog"></div>
</div>

<!-- MODAL -->
<div id="modal" class="modal" aria-hidden="true">
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal-sheet" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-header">
            <div style="display:flex;align-items:center;gap:8px">
                <button class="icon-btn" onclick="closeModal()" aria-label="Назад">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                <div class="modal-title" id="modal-title">Изделие</div>
            </div>
            <div class="modal-actions">
                <button class="icon-btn" id="favBtn" aria-label="Добавить в избранное" onclick="toggleFav(this)">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 21s-6.9-4.7-9-7.2C-1.2 9.6 4.2 3 12 8c7.8-5 13.2 1.6 9 5.8-2.1 2.5-9 7.2-9 7.2z"/></svg>
                </button>
            </div>
        </div>

        <div class="modal-content" id="modal-content">
            <div class="gallery" id="gallery-wrap">
                <div class="gallery-scroll" id="gallery"></div>
                <div class="gallery-controls">
                    <div class="arrow" id="prevBtn" onclick="galleryPrev()">‹</div>
                    <div class="arrow" id="nextBtn" onclick="galleryNext()">›</div>
                </div>
                <div class="gallery-dots" id="dots"></div>
            </div>

            <div class="details">
                <div class="product-top">
                    <div class="product-info">
                        <div class="product-title" id="product-name">Название</div>
                        <div class="product-price" id="product-price">0 ₽</div>
                        <div class="product-desc" id="product-desc">Описание товара. Коротко и ёмко, с акцентом на материал и посадку.</div>
                    </div>
                    <div style="width:120px;display:flex;flex-direction:column;align-items:flex-end;gap:8px">
                        <div style="opacity:0.6;font-size:13px">Категория</div>
                        <div style="font-weight:700;opacity:0.9" id="product-cat">---</div>
                    </div>
                </div>

                <div class="meta-row">
                    <div>
                        <div style="font-size:12px;opacity:0.6;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Выберите размер</div>
                        <div class="size-selector" id="sizeSelector">
                            <div class="size-chip" onclick="selectSize(this)">S</div>
                            <div class="size-chip" onclick="selectSize(this)">M</div>
                            <div class="size-chip" onclick="selectSize(this)">L</div>
                        </div>
                    </div>

                    <div style="margin-left:auto;display:flex;flex-direction:column;gap:8px;align-items:flex-end">
                        <div style="font-size:12px;color:var(--muted);">Количество</div>
                        <div class="qty">
                            <button onclick="changeQty(-1)" aria-label="Уменьшить">−</button>
                            <span id="qty">1</span>
                            <button onclick="changeQty(1)" aria-label="Увеличить">+</button>
                        </div>
                    </div>
                </div>

                <div style="margin-top:18px;color:var(--muted);font-size:14px;line-height:1.45" id="long-desc">
                    Дополнительная информация: уход за изделием, размеры и рекомендации. Здесь можно разместить расширенное описание или кнопку "Подробнее".
                </div>

            </div>
        </div>

        <div class="cta-row">
            <button class="add-btn" onclick="openCheckout()"><span>Добавить в корзину</span><span id="btn-price" style="margin-left:8px;font-weight:800"></span></button>
            <button class="buy-btn" onclick="fastBuy()" aria-label="Купить сейчас">✓</button>
        </div>
    </div>
</div>

<!-- Checkout Sheet (kept simple) -->
<div id="sheet" class="sheet">
    <div class="sheet-handle"></div>
    <h2 style="font-size:24px;margin-bottom:12px">Оформление</h2>
    <div style="display:flex;gap:12px;background:rgba(255,255,255,0.04);padding:12px;border-radius:12px">
        <img id="sheet-img" src="" style="width:60px;height:60px;border-radius:10px;object-fit:cover">
        <div>
            <div id="sheet-name" style="font-weight:700"></div>
            <div style="opacity:0.6;font-size:13px;margin-top:6px">Размер: <span id="sheet-size">S</span></div>
        </div>
    </div>

    <input type="text" id="addr" class="input-ios" placeholder="Адрес в Красноярске" value="ул. Мира, 10" style="width:100%;margin-top:16px;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:0;color:#fff">

    <div style="display:flex;justify-content:space-between;margin:14px 0;font-size:16px">
        <span style="opacity:0.6">Итого к оплате</span>
        <span id="sheet-total" style="font-weight:800;font-size:18px">0 ₽</span>
    </div>

    <button class="main-btn" style="width:100%;padding:14px;border-radius:12px;background:#fff;color:#000;border:0;font-weight:700" onclick="confirmPayment()">Оплатить Apple Pay</button>
</div>

<!-- Pay overlay -->
<div id="pay-overlay" class="pay-overlay">
    <div class="faceid-node"></div>
    <div style="font-size:20px;font-weight:500;margin-top:10px">Face ID</div>
    <div style="opacity:0.6;margin-top:6px">Двойное нажатие для подтверждения</div>
</div>

<script>
    const tg = window.Telegram?.WebApp || { expand:()=>{}, HapticFeedback: { impactOccurred:()=>{}, selectionChanged:()=>{}, notificationOccurred:()=>{} }, showAlert:alert };
    try{tg.expand()}catch(e){}

    const DATA = [
        { id: 1, cat: 'белье', name: "Silk Noir Set", price: 8900, imgs: ["photo1.jpg", "https://images.unsplash.com/photo-1516733725897-1aa73b87c8e8?w=1200", "https://images.unsplash.com/photo-1581333100576-b73bbebd3c2e?w=1200"], desc: "Премиальный шелк и французское кружево. Коллекция Noir 2026." },
        { id: 2, cat: 'пижамы', name: "Pearl Satin", price: 11500, imgs: ["photo2.jpg", "https://images.unsplash.com/photo-1598554747436-c9293d6a588f?w=1200"], desc: "Атласная пижама в жемчужном оттенке. Идеально для отдыха." },
        { id: 3, cat: 'белье', name: "Velvet Body", price: 7200, imgs: ["photo3.jpg", "https://images.unsplash.com/photo-1610384029267-3930d99bc361?w=1200"], desc: "Бархатное боди с глубоким вырезом. Подчеркивает силуэт." },
        { id: 4, cat: 'халаты', name: "Royal Kimono", price: 14900, imgs: ["photo4.jpg", "https://images.unsplash.com/photo-1566206091558-7f218b696731?w=1200"], desc: "Тяжелый шелк, ручная вышивка на спине. Лимитированная серия." }
    ];

    let currentItem = null;
    let currentIndex = 0;
    let qty = 1;

    function renderCatalog(){
        const c = document.getElementById('catalog');
        c.innerHTML = DATA.map(p => `
            <div class="card" onclick="openProduct(${p.id})">
                <div class="img-wrap"><img src="${p.imgs[0]}" onerror="this.src='https://via.placeholder.com/400x500/111/111'"></div>
                <div class="card-body">
                    <div class="card-name">${p.name}</div>
                    <div class="card-price">${p.price.toLocaleString()} ₽</div>
                </div>
            </div>
        `).join('');
    }

    function openProduct(id){
        currentItem = DATA.find(x=>x.id===id);
        if(!currentItem) return;
        currentIndex = 0; qty = 1;

        // Fill header/title
        document.getElementById('modal-title').innerText = currentItem.name;
        document.getElementById('product-name').innerText = currentItem.name;
        document.getElementById('product-price').innerText = currentItem.price.toLocaleString() + ' ₽';
        document.getElementById('product-desc').innerText = currentItem.desc;
        document.getElementById('product-cat').innerText = currentItem.cat;
        document.getElementById('btn-price').innerText = currentItem.price.toLocaleString() + ' ₽';
        document.getElementById('sheet-img').src = currentItem.imgs[0];
        document.getElementById('sheet-name').innerText = currentItem.name;
        document.getElementById('sheet-total').innerText = currentItem.price.toLocaleString() + ' ₽';
        document.getElementById('sheet-size').innerText = 'S';
        document.getElementById('qty').innerText = qty;

        // Build gallery
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = currentItem.imgs.map(src => `
            <div class="gallery-item"><img src="${src}" loading="lazy" onerror="this.src='https://via.placeholder.com/800x1000/111/111'"></div>
        `).join('');

        // Dots
        const dots = document.getElementById('dots');
        dots.innerHTML = currentItem.imgs.map((_,i)=>`<div class="dot ${i===0? 'active':''}" data-index="${i}" onclick="jumpTo(${i})"></div>`).join('');

        // Reset scroll
        setTimeout(()=>{document.getElementById('gallery').scrollLeft = 0},50);

        // Show modal
        const modal = document.getElementById('modal');
        modal.classList.add('show'); modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false');
        tg.HapticFeedback.impactOccurred('medium');

        // focus trap hint: focus first interactive
        setTimeout(()=>document.querySelector('.add-btn').focus(),200);

        // preload images quietly
        currentItem.imgs.forEach(src=>{const i=new Image();i.src=src});

        // update dots on scroll
        const g = document.getElementById('gallery');
        g.onscroll = () => updateDots(g);

        // keyboard ESC close
        document.addEventListener('keydown', escListener);
    }

    function escListener(e){ if(e.key === 'Escape') closeModal(); }

    function closeModal(){
        const modal = document.getElementById('modal');
        modal.classList.remove('show'); modal.style.display = 'none'; modal.setAttribute('aria-hidden','true');
        document.removeEventListener('keydown', escListener);
    }

    function updateDots(el){
        const index = Math.round(el.scrollLeft / el.offsetWidth);
        currentIndex = index;
        const dots = document.querySelectorAll('.dot');
        dots.forEach((d,i)=>d.classList.toggle('active', i===index));
    }

    function jumpTo(i){
        const g = document.getElementById('gallery');
        g.scrollTo({left: i * g.offsetWidth, behavior: 'smooth'});
    }

    function galleryNext(){ const g=document.getElementById('gallery'); g.scrollBy({left: g.offsetWidth, behavior:'smooth'});} 
    function galleryPrev(){ const g=document.getElementById('gallery'); g.scrollBy({left: -g.offsetWidth, behavior:'smooth'});} 

    function selectSize(el){
        document.querySelectorAll('.size-chip').forEach(c=>c.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('sheet-size').innerText = el.innerText;
        tg.HapticFeedback.selectionChanged();
    }

    function changeQty(delta){
        qty = Math.max(1, qty + delta);
        document.getElementById('qty').innerText = qty;
        document.getElementById('sheet-total').innerText = (currentItem.price * qty).toLocaleString() + ' ₽';
        document.getElementById('btn-price').innerText = (currentItem.price * qty).toLocaleString() + ' ₽';
    }

    function toggleFav(btn){
        btn.classList.toggle('active');
        btn.style.background = btn.classList.contains('active') ? 'linear-gradient(135deg,#ff7a7a,#ffb26b)' : '';
        tg.HapticFeedback.impactOccurred('light');
    }

    function openCheckout(){
        document.getElementById('sheet-img').src = currentItem.imgs[0];
        document.getElementById('sheet-name').innerText = currentItem.name;
        document.getElementById('sheet-total').innerText = (currentItem.price * qty).toLocaleString() + ' ₽';
        document.getElementById('sheet').classList.add('active');
        tg.HapticFeedback.impactOccurred('light');
    }

    function fastBuy(){
        openCheckout();
        // optionally open payment overlay directly
    }

    function confirmPayment(){
        const pay = document.getElementById('pay-overlay');
        pay.style.display = 'flex';
        tg.HapticFeedback.impactOccurred('heavy');
        setTimeout(()=>{
            pay.innerHTML = `<div style="color: ${getComputedStyle(document.documentElement).getPropertyValue('--success')}; font-size:60px;">✓</div><div style="font-size:20px;margin-top:10px;">Оплачено</div>`;
            tg.HapticFeedback.notificationOccurred('success');
            setTimeout(()=>{
                pay.style.display = 'none';
                document.getElementById('sheet').classList.remove('active');
                closeModal();
                tg.showAlert("Заказ принят! Мы свяжемся с вами для уточнения времени доставки.");
            },1200);
        },1400);
    }

    // Sakura animation (lightweight)
    const canvas = document.getElementById('sakura');
    const ctx = canvas.getContext('2d');
    let petals = [];
    function resize(){canvas.width = innerWidth; canvas.height = innerHeight}
    addEventListener('resize', resize); resize();
    class Petal{constructor(){this.init()}init(){this.x=Math.random()*canvas.width;this.y=Math.random()*-canvas.height;this.s=Math.random()*2+1;this.sp=Math.random()*0.6+0.2;this.o=Math.random()*0.25+0.05}update(){this.y+=this.sp;this.x+=Math.sin(this.y/80)*0.3;if(this.y>canvas.height)this.init()}draw(){ctx.beginPath();ctx.ellipse(this.x,this.y,this.s,this.s/2,Math.PI/4,0,Math.PI*2);ctx.fillStyle=`rgba(255,183,197,${this.o})`;ctx.fill()}}
    for(let i=0;i<30;i++)petals.push(new Petal());
    function animate(){ctx.clearRect(0,0,canvas.width,canvas.height);petals.forEach(p=>{p.update();p.draw()});requestAnimationFrame(animate)}
    animate();

    renderCatalog();

</script>
</body>
</html>
