<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>KRISS — Noir Edition</title>

  <!-- Telegram Web App (будет безопасно использоваться в коде ниже) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#000;
      --glass:rgba(255,255,255,0.03);
      --glass-active:rgba(255,255,255,0.08);
      --hairline:rgba(255,255,255,0.1);
      --sakura:#ffb7c5;
      --accent:#fff;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      background:var(--bg);
      color:#fff;
      font-family:'Inter',-apple-system,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
    }

    canvas{position:fixed;inset:0;width:100%;height:100%;z-index:0;pointer-events:none}

    .app{position:relative;z-index:1;padding:calc(env(safe-area-inset-top) + 10px) 16px 140px;min-height:100vh}

    header{display:flex;flex-direction:column;gap:16px;padding:10px 0 20px 4px;align-items:flex-start}
    .logo-img{height:42px;width:auto;object-fit:contain;opacity:.98}

    .search-container{display:none;width:100%;animation:slideDown .25s ease}
    @keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
    .search-input{
      width:100%;background:rgba(255,255,255,0.05);border:1px solid var(--hairline);
      border-radius:14px;padding:12px 14px;color:#fff;font-family:Inter;outline:none;
      backdrop-filter:blur(8px)
    }

    .nav-container{display:flex;justify-content:center;margin-bottom:20px;position:sticky;top:calc(env(safe-area-inset-top) + 10px);z-index:100}
    .nav-capsule{display:flex;background:rgba(15,15,15,0.75);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);padding:4px;border-radius:22px;width:100%;box-shadow:inset 0 0 0 0.5px var(--hairline)}
    .nav-item{flex:1;text-align:center;padding:10px 0;border-radius:18px;font-size:13px;font-weight:300;color:rgba(255,255,255,0.4);cursor:pointer}
    .nav-item.active{background:rgba(255,255,255,0.1);color:#fff}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}

    .card{background:var(--glass);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-radius:20px;overflow:hidden;position:relative;box-shadow:inset 0 0 0 0.5px var(--hairline)}
    .img-wrap{width:100%;aspect-ratio:0.75;overflow:hidden;background:#0a0a0a;position:relative;cursor:pointer}
    .card img{width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .45s ease;display:block}
    .card img.loaded{opacity:1}
    .fav-quick-btn{position:absolute;top:10px;right:10px;z-index:2;background:rgba(0,0,0,0.3);backdrop-filter:blur(6px);width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.08);cursor:pointer}
    .fav-quick-btn.active svg{fill:var(--sakura);stroke:var(--sakura)}

    .card-body{padding:12px;cursor:pointer}
    .card-cat{font-size:9px;font-weight:200;opacity:.45;text-transform:uppercase;letter-spacing:1.4px}
    .card-name{font-size:14px;font-weight:300;margin:6px 0;color:rgba(255,255,255,0.92)}
    .card-price{font-size:15px;font-weight:400}

    .dock-container{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom) + 20px);z-index:1000}
    .dock{background:rgba(10,10,10,0.82);backdrop-filter:blur(30px) saturate(1.2);-webkit-backdrop-filter:blur(30px) saturate(1.2);padding:12px 32px;border-radius:40px;display:flex;gap:36px;box-shadow:inset 0 0 0 0.5px var(--hairline),0 18px 36px rgba(0,0,0,0.45)}
    .dock-btn{display:flex;flex-direction:column;align-items:center;opacity:.35;transition:opacity .2s;cursor:pointer}
    .dock-btn.active{opacity:1}
    .dock-btn svg{width:22px;height:22px;margin-bottom:4px}
    .dock-btn span{font-size:9px;font-weight:300;letter-spacing:.5px}

    .modal{position:fixed;inset:0;background:#000;z-index:2000;display:none;flex-direction:column;animation:ios-slide .36s cubic-bezier(.1,.9,.2,1)}
    @keyframes ios-slide{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal-nav{padding:calc(env(safe-area-inset-top) + 14px) 20px 10px;display:flex;justify-content:space-between;align-items:center}
    .close-btn{background:var(--glass-active);padding:8px 18px;border-radius:20px;font-size:14px;font-weight:300;cursor:pointer}
    .modal-body{padding:0 20px 120px;overflow-y:auto}
    .modal-img-box{width:100%;border-radius:20px;overflow:hidden;margin-bottom:18px;box-shadow:inset 0 0 0 0.5px var(--hairline)}
    .modal-img-box img{width:100%;display:block}

    .size-wrap{display:flex;gap:10px;margin:18px 0}
    .size-btn{flex:1;padding:14px;border-radius:16px;background:var(--glass);box-shadow:inset 0 0 0 0.5px var(--hairline);text-align:center;font-weight:300;cursor:pointer}
    .size-btn.active{background:#fff;color:#000;font-weight:500}
    .buy-btn{width:100%;padding:18px;border-radius:22px;background:#fff;color:#000;border:none;font-size:16px;font-weight:500;cursor:pointer}

    .empty-state{text-align:center;margin-top:80px;opacity:.4;font-weight:200;grid-column:1/3}
  </style>
</head>
<body>
  <canvas id="sakura" aria-hidden="true"></canvas>

  <div class="app" role="application" aria-label="KRISS магазин">
    <header id="app-header">
      <!-- Логотип: kriss.png рядом с HTML-файлом. Опционно добавь kriss@2x.png -->
      <img
        src="kriss.png"
        srcset="kriss.png 1x, kriss@2x.png 2x"
        alt="KRISS"
        class="logo-img"
        decoding="async"
        loading="eager"
      >

      <div class="search-container" id="search-box">
        <input id="search-input" class="search-input" type="text" placeholder="Поиск изделий..." oninput="handleSearch()" aria-label="Поиск изделий">
      </div>
    </header>

    <div class="nav-container" id="nav-container">
      <div class="nav-capsule" role="tablist" aria-label="Фильтр по категориям">
        <div class="nav-item active" role="tab" onclick="setFilter('все', this)">Все</div>
        <div class="nav-item" role="tab" onclick="setFilter('белье', this)">Белье</div>
        <div class="nav-item" role="tab" onclick="setFilter('пижамы', this)">Пижамы</div>
        <div class="nav-item" role="tab" onclick="setFilter('халаты', this)">Халаты</div>
      </div>
    </div>

    <div class="grid" id="catalog" aria-live="polite"></div>
  </div>

  <div class="dock-container">
    <div class="dock">
      <div class="dock-btn active" id="btn-shop" onclick="switchTab('shop')" role="button" aria-pressed="true">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" stroke-width="1.2"/></svg>
        <span>МАГАЗИН</span>
      </div>
      <div class="dock-btn" id="btn-search" onclick="switchTab('search')" role="button">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="1.2"/></svg>
        <span>ПОИСК</span>
      </div>
      <div class="dock-btn" id="btn-fav" onclick="switchTab('fav')" role="button">
        <svg fill="none" stroke="currentColor" id="fav-dock-icon" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" stroke-width="1.2"/></svg>
        <span>ЛЮБИМОЕ</span>
      </div>
    </div>
  </div>

  <div id="modal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-nav">
      <div class="close-btn" onclick="closeModal()" role="button">Назад</div>
      <div style="font-weight:200;letter-spacing:2px;font-size:13px;opacity:.5">KRISS NOIR</div>
      <div style="width:60px"></div>
    </div>
    <div class="modal-body" id="modal-content"></div>
  </div>

  <script>
    // Безопасный доступ к Telegram WebApp API (если открыт внутри Telegram)
    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (tg && typeof tg.expand === 'function') {
      tg.expand();
      try { tg.backgroundColor = '#000000'; } catch (e) { /* ignore */ }
    }

    const PRODUCTS = [
      { id:1, cat:'белье', name:"Lace Noir Set", price:8500, img:"photo1.jpg", desc:"Сексуальное черное кружево ручной работы. Идеальная посадка и французский шарм." },
      { id:2, cat:'пижамы', name:"Silk Pearl Gown", price:12900, img:"photo2.jpg", desc:"Натуральный шелк в жемчужном оттенке. Невесомая роскошь для ваших ночей." },
      { id:3, cat:'белье', name:"Passion Body", price:7400, img:"photo3.jpg", desc:"Кружевное боди, подчеркивающее каждую линию тела. Смелый выбор." },
      { id:4, cat:'халаты', name:"Midnight Kimono", price:15600, img:"photo4.jpg", desc:"Длинный халат из тяжелого шелка. Глубокий черный цвет и матовый блеск." }
    ];

    let favorites = JSON.parse(localStorage.getItem('kriss_favs') || '[]');
    let currentTab = 'shop';
    let currentFilter = 'все';

    function render(data){
      const catalog = document.getElementById('catalog');
      if(!data || data.length === 0){
        catalog.innerHTML = `<div class="empty-state">Ничего не найдено</div>`;
        return;
      }
      catalog.innerHTML = data.map(p => {
        const isFav = favorites.includes(p.id);
        return `
          <div class="card" role="article" aria-label="${p.name}">
            <div class="fav-quick-btn ${isFav ? 'active' : ''}" onclick="toggleFav(event, ${p.id})" aria-pressed="${isFav}">
              <svg width="18" height="18" fill="${isFav ? 'var(--sakura)' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" stroke-width="1.5"/></svg>
            </div>
            <div class="img-wrap" onclick="openProduct(${p.id})">
              <img data-src="${p.img}" alt="${p.name}" loading="lazy" decoding="async" onload="this.classList.add('loaded')" src="https://via.placeholder.com/400x600/111/111?text=KRISS">
            </div>
            <div class="card-body" onclick="openProduct(${p.id})">
              <div class="card-cat">${p.cat}</div>
              <div class="card-name">${p.name}</div>
              <div class="card-price">${p.price.toLocaleString()} ₽</div>
            </div>
          </div>
        `;
      }).join('');
      // Подгружаем реальные src картинок после рендера (плавная подстановка)
      document.querySelectorAll('.img-wrap img[data-src]').forEach(img => {
        const real = img.getAttribute('data-src');
        const tmp = new Image();
        tmp.onload = () => { img.src = real; };
        tmp.src = real;
      });
    }

    function switchTab(tab){
      currentTab = tab;
      document.querySelectorAll('.dock-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('search-box').style.display = 'none';
      document.getElementById('nav-container').style.display = 'flex';

      if(tab === 'shop'){
        document.getElementById('btn-shop').classList.add('active');
        render(PRODUCTS.filter(p => currentFilter === 'все' || p.cat === currentFilter));
      } else if(tab === 'search'){
        document.getElementById('btn-search').classList.add('active');
        document.getElementById('search-box').style.display = 'block';
        document.getElementById('search-input').focus();
        handleSearch();
      } else if(tab === 'fav'){
        document.getElementById('btn-fav').classList.add('active');
        document.getElementById('nav-container').style.display = 'none';
        const favProducts = PRODUCTS.filter(p => favorites.includes(p.id));
        render(favProducts);
      }
      if(tg && tg.HapticFeedback) try { tg.HapticFeedback.impactOccurred('light'); } catch(e){}
    }

    function handleSearch(){
      const query = document.getElementById('search-input').value.toLowerCase();
      const filtered = PRODUCTS.filter(p => p.name.toLowerCase().includes(query) || p.cat.toLowerCase().includes(query));
      render(filtered);
    }

    function setFilter(category, el){
      currentFilter = category;
      document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
      el.classList.add('active');
      if(currentTab === 'shop') render(PRODUCTS.filter(p => category === 'все' || p.cat === category));
      if(tg && tg.HapticFeedback) try { tg.HapticFeedback.impactOccurred('light'); } catch(e){}
    }

    function toggleFav(event, id){
      event.stopPropagation();
      if(favorites.includes(id)) favorites = favorites.filter(fid => fid !== id);
      else { favorites.push(id); if(tg && tg.HapticFeedback) try { tg.HapticFeedback.notificationOccurred('success'); } catch(e){} }
      localStorage.setItem('kriss_favs', JSON.stringify(favorites));
      // Обновляем вид
      if(currentTab === 'fav') switchTab('fav'); else render(
        PRODUCTS.filter(p => currentTab === 'search' ? true : (currentFilter === 'все' || p.cat === currentFilter))
      );
      if(tg && tg.HapticFeedback) try { tg.HapticFeedback.impactOccurred('medium'); } catch(e){}
    }

    function openProduct(id){
      const p = PRODUCTS.find(x => x.id === id);
      const modal = document.getElementById('modal');
      const content = document.getElementById('modal-content');
      content.innerHTML = `
        <div class="modal-img-box"><img src="${p.img}" alt="${p.name}" loading="lazy" decoding="async"></div>
        <div class="card-cat" style="margin-bottom:8px">${p.cat}</div>
        <h2 style="font-weight:200;font-size:28px;margin-bottom:12px">${p.name}</h2>
        <p style="opacity:.6;font-weight:300;line-height:1.6;margin-bottom:20px">${p.desc}</p>
        <div class="size-wrap">
          <div class="size-btn active" onclick="selectSize(this)">S</div>
          <div class="size-btn" onclick="selectSize(this)">M</div>
          <div class="size-btn" onclick="selectSize(this)">L</div>
        </div>
        <button class="buy-btn" onclick="addToCart(${p.id})">Добавить — ${p.price.toLocaleString()} ₽</button>
      `;
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
      if(tg && tg.HapticFeedback) try { tg.HapticFeedback.impactOccurred('medium'); } catch(e){}
    }

    function selectSize(el){
      document.querySelectorAll('.size-btn').forEach(s => s.classList.remove('active'));
      el.classList.add('active');
      if(tg && tg.HapticFeedback) try { tg.HapticFeedback.selectionChanged(); } catch(e){}
    }

    function closeModal(){
      const modal = document.getElementById('modal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }

    function addToCart(id){
      if(tg && tg.HapticFeedback) try { tg.HapticFeedback.notificationOccurred('success'); } catch(e){}
      closeModal();
      if(tg && typeof tg.showAlert === 'function') tg.showAlert('Товар добавлен в корзину');
      else alert('Товар добавлен в корзину');
    }

    // Sakura animation (как у тебя было)
    const canvas = document.getElementById('sakura');
    const ctx = canvas.getContext && canvas.getContext('2d');
    let petals = [];
    function resize(){ if(!canvas) return; canvas.width = innerWidth; canvas.height = innerHeight; }
    window.addEventListener('resize', resize);
    resize();

    class Petal { constructor(){ this.init() } init(){ this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height - canvas.height; this.size=Math.random()*2.5+1; this.speed=Math.random()*0.2+0.1; this.angle=Math.random()*Math.PI*2; this.spin=Math.random()*0.01-0.005; this.opacity=Math.random()*0.12+0.04 } update(){ this.y += this.speed; this.x += Math.sin(this.y/100)*0.15; this.angle += this.spin; if(this.y>canvas.height) this.init() } draw(){ if(!ctx) return; ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.angle); ctx.beginPath(); ctx.ellipse(0,0,this.size,this.size/2,0,0,Math.PI*2); ctx.fillStyle = `rgba(255,183,197,${this.opacity})`; ctx.fill(); ctx.restore() } }
    for(let i=0;i<22;i++) petals.push(new Petal());
    function animate(){ if(!ctx) return; ctx.clearRect(0,0,canvas.width,canvas.height); petals.forEach(p=>{p.update();p.draw()}); requestAnimationFrame(animate) }
    animate();

    // Initial render
    render(PRODUCTS);
    /* --- Авто-открытие товара из URL (?product=product_1 или ?product=1) --- */
(function(){
  try {
    const params = new URLSearchParams(window.location.search);
    const productParam = params.get('product'); // ожидаем "product_1" или "1"
    let pid = null;
    if (productParam) {
      if (productParam.startsWith('product_')) {
        pid = parseInt(productParam.replace('product_', ''), 10);
      } else if (/^\d+$/.test(productParam)) {
        pid = parseInt(productParam, 10);
      }
    }
    if (pid) {
      // немного ждем, чтобы DOM и рендер завершились
      setTimeout(() => {
        if (typeof openProduct === 'function') {
          openProduct(pid, false); // false — не пушить новый history, просто открыть
        } else {
          console.warn('openProduct не найден в глобальной области');
        }
      }, 120);
    }
  } catch (e) {
    console.error('Auto-open product error:', e);
  })
  </script>
</body>
</html>
